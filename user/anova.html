<!DOCTYPE html>
<script>window.location = "https://anova.chat/chat";</script>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <link href="../icons/icon.png" rel="icon" type="image/png">
    <title>Backyard Bandwidth • Anova</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/github.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/marked-katex-extension@4.0.4/lib/index.umd.min.js"></script>

<script>
    window.addEventListener("DOMContentLoaded", () => {
      marked.setOptions({
        gfm: true,
        breaks: true,
        smartLists: true,
        smartypants: false,
        highlight: (code, lang) => {
          try {
            if (window.hljs) {
              if (lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
              }
              return hljs.highlightAuto(code).value;
            }
          } catch (e) {
            console.warn("HLJS highlight error:", e);
          }
          return code;
        }
      });

      if (window.markedKatex) {
        marked.use(window.markedKatex({
          katex: window.katex,
          output: "html",
          throwOnError: false,
          delimiters: [
            { left: "$$", right: "$$", display: true },   // block math
            { left: "$", right: "$", display: false },    // inline math
            { left: "\\(", right: "\\)", display: false }, // inline alt
            { left: "\\[", right: "\\]", display: true }   // block alt
          ]
        }));
      } else {
        console.error("marked-katex-extension not loaded.");
      }
    });
</script>


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bLightBlue: "#6ec1e4",
                        bLightBlueHover: "#008CCB",
                        bDarkBlue: "#2d6ea8",
                        bDarkGrey: "#1A1A1A",
                        bLightGrey: "#aaa",
                        bGreyHover: "#81868c",
                        bGreen: "#4caf50",
                        bGreenHover: "#008000FF",
                        bRed: "#E33434",
                        bRedHover: "#972424"
                    }
                }
            }
        }
    </script>
    <style>
        .scroll-shadow {
            mask-image: linear-gradient(to bottom, transparent, black 16px, black calc(100% - 16px), transparent);
        }

        body {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .bubble pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .typing {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            height: 1em;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 9999px;
            background: #9ca3af;
            opacity: 0.35;
            animation: typing-bounce 1s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: .2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: .4s;
        }

        @keyframes typing-bounce {
            0%, 80%, 100% {
                transform: translateY(0);
                opacity: .35;
            }
            40% {
                transform: translateY(-5px);
                opacity: 1;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            .typing-dot {
                animation: none;
                opacity: .75;
            }
        }

        .bubble .md pre {
            padding: 0.75rem 1rem;
            margin: 0.85rem 0;
            border-radius: 0.5rem;
            background: #f6f8fa;
            border: 1px solid #e5e7eb;
            overflow: auto;
        }

        .bubble .md pre > code {
            display: block;
            padding: 0;
            background: transparent;
        }

        .bubble .md :not(pre) > code {
            background: #f3f4f6;
            padding: 0.15rem 0.35rem;
            border-radius: 0.25rem;
        }
    </style>
</head>

<body class="bg-gray-100 h-dvh flex flex-col overflow-hidden" onload="boot()">

<header class="w-full bg-black text-white flex items-center justify-between px-6 py-2 shadow-md">
    <div class="flex items-center space-x-3">
        <a href="../index.html">
            <img alt="Logo" class="max-h-14 w-auto object-contain"
                 src="../icons/anova-logo-words.png"/>
        </a>
        <span class="text-lg font-bold tracking-wide">by Backyard Bandwidth</span>
        <span class="ml-3 text-xs bg-bDarkBlue/60 px-2 py-0.5 rounded hidden" id="env-pill"
              style="display: none"></span>
    </div>

    <div class="flex items-center gap-2">
        <span class="hidden" id="customer-username"></span>
        <span class="text-xs bg-bDarkBlue/60 text-white px-2 py-0.5 rounded" id="token-pill"
              style="display: none"
              title="Total tokens used this session">
  Tokens used: <span id="token-count">0</span>
</span>
        <a class="bg-bLightGrey hover:bg-bGreyHover text-black px-4 py-2 rounded text-sm font-semibold"
           href="dashboard.html" target="_blank">Dashboard</a>
        <a class="bg-bLightGrey hover:bg-bGreyHover text-black px-4 py-2 rounded text-sm font-semibold"
           href="../anova-policy.html" target="_blank">Policy</a>
        <button class="bg-bRed hover:bg-bRedHover text-white px-4 py-2 rounded text-sm font-semibold"
                onclick="logout()">Logout
        </button>
    </div>
</header>

<!-- Main -->
<main class="max-w-7xl mx-auto p-4 flex-1 min-h-0 flex overflow-hidden">
    <!-- Card -->
    <section class="bg-white rounded-2xl shadow-lg p-4 md:p-6 flex-1 flex flex-col min-h-0 overflow-hidden">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-xl font-bold text-gray-800">Ask Anova</h1>
            <div class="flex items-center gap-2">
                <button class="text-sm text-white px-3 py-1.5 rounded bg-bRed hover:bg-bRedHover" id="btn-clear"
                        onclick="clearChat()" title="Clear chat">Clear Chat
                </button>
                <button class="text-sm px-3 py-1.5 rounded bg-bGreen hover:bg-bGreenHover text-white"
                        id="btn-copy"
                        onclick="copyLast()" title="Copy last AI reply">Copy Last
                </button>
                <button class="text-sm px-3 py-1.5 rounded bg-bLightBlue hover:bg-bLightBlueHover text-white"
                        id="btn-export"
                        onclick="exportChat()" title="Download chat as PDF">Export PDF
                </button>
            </div>

        </div>

        <!-- Messages -->
        <div class="scroll-shadow flex-1 min-h-0 overflow-y-auto pr-1 space-y-3 bg-gray-50 rounded-lg p-3 border border-gray-200"
             id="messages">
            <!-- Bubbles will be appended here -->
            <div class="bubble flex items-start gap-3">
                <div class="w-8 h-8 rounded-full flex-shrink-0 bg-bDarkGrey text-white grid place-items-center font-bold">
                    BB
                </div>
                <div class="max-w-[92%] md:max-w-[85%] bg-white border border-gray-200 rounded-xl p-3 text-sm leading-relaxed">
<pre>
You are now connected with Anova — a stateless LLM built for privacy. Anova never saves, logs, or remembers your input. Each message is processed in real time, then wiped from memory. By using Anova, you accept our <u><a
        href="../anova-policy.html"
        target="_blank">Stateless LLM Policy</a></u>. Your data stays yours. Press Enter to send, or Shift+Enter for a new line.
</pre>
                </div>
            </div>
        </div>

        <!-- Composer -->
        <div class="mt-4 grid grid-cols-1 gap-2">
            <div class="relative">
                <textarea
                        class="w-full border border-gray-300 rounded-xl p-3 pr-24 min-h-[96px] resize-none focus:outline-none focus:ring-2 focus:ring-bLightBlue"
                        id="input"
                        onkeydown="handleKey(event)"
                        placeholder="Your data. Your freedom. Your privacy. Ask anything..."
                        style="height: 128px;"></textarea>
                <!-- Corner resize control -->
                <div aria-hidden="false"
                     class="absolute right-[84px] bottom-2 flex flex-col gap-1 select-none" id="input-resize-controls">
                    <button class="h-6 w-6 grid place-items-center rounded bg-white border border-gray-300 text-xs hover:bg-gray-50 shadow-sm"
                            onclick="adjustInputHeight(1)"
                            title="Increase input height (Ctrl + =)"
                            type="button">＋
                    </button>
                    <button class="h-6 w-6 grid place-items-center rounded bg-white border border-gray-300 text-xs hover:bg-gray-50 shadow-sm"
                            onclick="adjustInputHeight(-1)"
                            title="Decrease input height (Ctrl + -)"
                            type="button">−
                    </button>
                </div>


                <div class="absolute right-2 bottom-2 flex gap-2">
                    <!-- Debug toggle for reproducing unsuccessful (omit username) -->
                    <label class="hidden items-center gap-1 text-xs text-gray-500 mr-2 select-none" id="omit-user-wrap"
                           title="For testing unsuccessful requests (success: false)">
                        <input class="accent-bRed" id="omit-username" style="display: none" type="checkbox">
                        <!--            omit username-->
                    </label>
                    <button class="bg-bGreen hover:bg-bGreenHover text-white px-4 py-2 rounded font-semibold"
                            id="send-btn"
                            onclick="sendMessage()">Send
                    </button>
                </div>
            </div>

            <div class="text-xs text-gray-600 flex flex-col space-y-1">
                <span>Press <b>Enter</b> to send • <b>Shift + Enter</b> for a new line</span>
                <span>Press <b>Control + =</b> to increase input height • <b>Control + -</b> to decrease input height</span>
                <span><b>Reminder:</b> Anova isn’t perfect — always double-check important info</span>
                <span class="hidden" id="status"></span>
            </div>

        </div>
    </section>
</main>

<div class="fixed inset-0 bg-black/40 backdrop-blur-[1px] hidden items-center justify-center z-50"
     id="thinking-overlay">
    <div class="bg-white rounded-2xl shadow-xl px-6 py-5 text-center w-[92%] max-w-sm border border-gray-200">
        <div class="mx-auto mb-3 h-10 w-10 rounded-full border-4 border-bLightBlue border-t-transparent animate-spin"></div>
        <div class="text-base font-semibold tracking-wide" id="thinking-text">thinking..</div>
        <!--    <div class="mt-1 text-xs text-gray-500">Anova is cooking your answer</div>-->
    </div>
</div>

<script>
    let API_BASE_URL = "";
    let TOKEN = "";
    let USERNAME = "";
    let totalTokens = 0;

    async function ensureHljs() {
        if (window.hljs) return true;
        try {
            await new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = "https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/build/highlight.min.js";
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });
            return !!window.hljs;
        } catch (e) {
            console.warn("Failed to load highlight.js dynamically:", e);
            return false;
        }
    }

    function addTokens(n) {
        const v = Number(n) || 0;
        totalTokens += v;
        const el = document.getElementById('token-count');
        if (el) el.textContent = totalTokens.toLocaleString();
    }

    async function boot() {
        try {
            const isDev =
                location.hostname.includes("localhost") ||
                location.hostname === "127.0.0.1";

            let config = {dev: "", prod: ""};
            try {
                const envRes = await fetch("../data/env.json", {cache: "no-store"});
                if (envRes.ok) config = await envRes.json();
                else console.warn("env.json fetch failed:", envRes.status);
            } catch (e) {
                console.warn("env.json fetch threw:", e);
            }

            if (!config.dev && !config.prod) {
                console.warn("env.json missing; defaulting API_BASE_URL to /api");
                config = {dev: "/api", prod: "/api"};
            }

            API_BASE_URL = isDev ? config.dev : config.prod;

            const envPill = document.getElementById("env-pill");
            if (API_BASE_URL) {
                envPill.textContent = `${isDev ? "DEV" : "PROD"}: ${API_BASE_URL}`;
                envPill.classList.remove("hidden");
            } else {
                toast("No API base set (check env.json).");
            }

            const raw = localStorage.getItem("dashboardData");
            if (!raw) return redirect();

            const parsed = JSON.parse(raw);
            if (Date.now() > (parsed.expires || 0)) {
                localStorage.removeItem("dashboardData");
                return redirect();
            }
            const data = parsed.data || {};
            TOKEN = data.token || "";
            USERNAME = (data.customer_username || "").trim();


            const u = document.getElementById("customer-username");
            if (u && USERNAME) u.textContent = USERNAME;


            if (isDev) document.getElementById("omit-user-wrap").classList.remove("hidden");


            document.getElementById("input").focus();
        } catch (e) {
            console.error(e);
            redirect();
        }
    }

    function redirect() {
        window.location = "login.html";
    }

    function logout() {
        localStorage.removeItem("dashboardData");
        redirect();
    }


    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send-btn");

    let inflight = false;
    let currentAbort = null;
    let inlineThink = null;

    function handleKey(e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            if (inflight) {
                cancelRequest("Stopped by keyboard");
            } else {
                sendMessage();
            }
        }
        if (e.key === "Escape" && inflight) {
            e.preventDefault();
            cancelRequest("Stopped");
        }
    }

    function appendBubble({role, text, success = null}) {
        const wrap = document.createElement("div");
        wrap.className = "bubble flex items-start gap-3";

        const avatar = document.createElement("div");
        avatar.className = "w-8 h-8 rounded-full flex-shrink-0 grid place-items-center font-bold";
        if (role === "user") {
            const initial = getUserInitial();
            avatar.textContent = initial;
            avatar.title = USERNAME || "";
            avatar.classList.add("bg-bLightBlue", "text-white");
        } else if (role === "assistant") {
    const img = document.createElement("img");
    img.src = "../icons/anova-logo.png";
    img.alt = "Anova Logo";
    img.className = "w-6 h-6 object-contain";
    avatar.appendChild(img);
    avatar.classList.add("bg-black");
        } else {
            avatar.textContent = "!";
            avatar.classList.add("bg-bRed", "text-white");
        }

        const bubble = document.createElement("div");
        bubble.className = "relative max-w-[92%] md:max-w-[85%] rounded-xl p-3 text-sm leading-relaxed";
        if (role === "user") {
            bubble.classList.add("bg-bLightBlue", "text-white");
        } else if (role === "assistant") {
            bubble.classList.add("bg-white", "border", "border-gray-200");
        } else {
            bubble.classList.add("bg-white", "border", "border-bRed");
        }

        const originalMD = String(text || "");
        bubble.dataset.md = originalMD;

        let contentEl;
        if (role === "assistant") {
            const html = DOMPurify.sanitize(marked.parse(originalMD || ""), {USE_PROFILES: {html: true}});
            contentEl = document.createElement("div");
            contentEl.className = "md";
            contentEl.innerHTML = html || "<pre></pre>";

            (async () => {
                const ok = await ensureHljs();
                if (ok && window.hljs) {
                    try {
                        contentEl.querySelectorAll("pre code").forEach((codeEl) => {
                            hljs.highlightElement(codeEl);
                        });
                    } catch (e) {
                        console.warn("highlightElement failed:", e);
                    }
                }
            })();
            contentEl.querySelectorAll("pre").forEach((pre) => {
                pre.classList.add(
                    "relative", "group",
                    "rounded-lg", "border", "border-gray-200",
                    "bg-gray-50", "p-4", "my-3", "overflow-auto"
                );
                const btn = document.createElement("button");
                btn.type = "button";
                btn.title = "Copy code";
                btn.textContent = "Copy";
                btn.className = "hidden group-hover:block absolute top-2 right-2 text-[10px] bg-bLightGrey hover:bg-bGreyHover text-black px-2 py-0.5 rounded border border-gray-300";
                btn.addEventListener("click", async () => {
                    const code = pre.querySelector("code");
                    const toCopy = code ? code.innerText : pre.innerText;
                    await copyString(toCopy);
                });
                pre.appendChild(btn);
            });
        } else {
            contentEl = document.createElement("pre");
            contentEl.textContent = originalMD;
        }
        bubble.appendChild(contentEl);


        if (success === false) {
            const row = document.createElement("div");
            row.className = "mt-2 flex items-center justify-between gap-3 text-xs";
            const pill = document.createElement("span");
            pill.className = "px-2 py-0.5 rounded font-semibold bg-red-100 text-red-700";
            pill.textContent = "Unable to perform request";
            row.appendChild(pill);
            bubble.appendChild(row);
        }

        wrap.appendChild(avatar);
        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return wrap;
    }

    function clearChat() {
        messagesEl.innerHTML = "";
        totalTokens = 0;
        const el = document.getElementById('token-count');
        if (el) el.textContent = "0";
        messagesEl.innerHTML = "            <div class=\"bubble flex items-start gap-3\">\n" +
            "                <div class=\"w-8 h-8 rounded-full flex-shrink-0 bg-bDarkGrey text-white grid place-items-center font-bold\">\n" +
            "                    BB\n" +
            "                </div>\n" +
            "                <div class=\"max-w-[92%] md:max-w-[85%] bg-white border border-gray-200 rounded-xl p-3 text-sm leading-relaxed\">\n" +
            "<pre>\n" +
            "You are now connected with Anova — a stateless LLM built for privacy. Anova never saves, logs, or remembers your input. Each message is processed in real time, then wiped from memory. By using Anova, you accept our <u><a href=\"../anova-policy.html\">Stateless LLM Policy</a></u>. Your data stays yours. Press Enter to send, or Shift+Enter for a new line.\n" +
            "</pre>                </div>\n" +
            "            </div>";
    }

    function copyLast() {
        const bubbles = messagesEl.querySelectorAll(".bubble");

        for (let i = bubbles.length - 1; i >= 0; i--) {
            const label = bubbles[i].querySelector(".w-8");
            if (!label) continue;
            const isAssistant = label.textContent === "A" || label.textContent === "BB";
            if (isAssistant) {
                const md = bubbles[i].querySelector(".relative")?.dataset?.md;
                if (md) {
                    copyString(md);
                    return;
                }

                const pre = bubbles[i].querySelector("pre");
                const text = pre?.textContent || bubbles[i].innerText || "";
                copyString(text);
                return;
            }
        }
        toast("No AI reply to copy yet.");
    }


    function toast(msg) {
        const s = document.getElementById("status");
        s.textContent = msg;
        s.classList.remove("hidden");
        setTimeout(() => s.classList.add("hidden"), 1500);
    }

    let thinkingTimer = null;

    function showThinking() {

    }

    function hideThinking() {

    }

    function createThinkingBubble() {

        const wrap = appendBubble({role: "assistant", text: ""});


        const md = wrap.querySelector(".md");
        const pre = wrap.querySelector("pre");
        const target = md || pre || wrap;
        target.innerHTML = "";
        target.appendChild(makeTypingDots());

        return {
            remove: () => wrap.remove(),
            el: wrap
        };
    }


    async function sendMessage() {
        if (inflight) {
            cancelRequest("Stopped");
            return;
        }

        const prompt = (inputEl.value || "").trim();
        if (!prompt) {
            toast("Type something first.");
            return;
        }

        appendBubble({role: "user", text: prompt});
        inputEl.value = "";
        inputEl.style.height = "auto";

        inflight = true;
        setSendButtonMode("stop");
        inlineThink = createThinkingBubble();
        currentAbort = new AbortController();

        try {
            const body = {token: TOKEN, username: USERNAME, prompt};
            const res = await fetch(`${API_BASE_URL}/user/llm/send`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(body),
                signal: currentAbort.signal
            });

            if (currentAbort.signal.aborted) throw new DOMException("Aborted", "AbortError");

            const json = await res.json().catch(() => ({}));
            if (currentAbort.signal.aborted) throw new DOMException("Aborted", "AbortError");

            const success = !!json.success;
            const reply = (json.data?.answer || json?.error?.msg || "No reply");

            inlineThink?.remove();
            inlineThink = null;

            appendBubble({
                role: success ? "assistant" : "error",
                text: reply,
                success
            });
        } catch (err) {
            inlineThink?.remove();
            inlineThink = null;

            if (err?.name === "AbortError") {
                appendBubble({
                    role: "error",
                    text: "User stopped request",
                    success: false
                });
            } else {
                appendBubble({
                    role: "error",
                    text: `Network error: ${err?.message || err}`,
                    success: false
                });
            }
        } finally {
            inflight = false;
            currentAbort = null;
            setSendButtonMode("send");
            inputEl.focus();
        }
    }

    async function copyString(text) {
        try {
            await navigator.clipboard.writeText(text);
            toast("Copied.");
        } catch (e) {
            console.error(e);
            toast("Copy failed");
        }
    }

    function makeTypingDots() {
        const wrap = document.createElement('span');
        wrap.className = 'typing';
        wrap.setAttribute('aria-label', 'Assistant is typing');
        wrap.setAttribute('role', 'status');

        for (let i = 0; i < 3; i++) {
            const d = document.createElement('span');
            d.className = 'typing-dot';
            wrap.appendChild(d);
        }
        return wrap;
    }

    function getUserInitial() {
        const u = (USERNAME || "").trim();
        if (!u) return "U";
        const m = u.match(/[A-Za-z0-9]/);
        return (m ? m[0] : u[0]).toUpperCase();
    }

    function exportChat() {
        const container = document.getElementById('messages');
        if (!container) return toast("No chat to export.");

        const wrapper = document.createElement('div');
        wrapper.style.padding = '16px';
        wrapper.style.fontFamily = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';

        const title = document.createElement('div');
        title.style.fontSize = '18px';
        title.style.fontWeight = '700';
        title.style.marginBottom = '4px';
        title.textContent = 'Backyard Bandwidth • Anova — Chat Export';

        const subtitle = document.createElement('div');
        subtitle.style.fontSize = '12px';
        subtitle.style.color = '#6b7280';
        subtitle.style.marginBottom = '12px';
        const now = new Date();
        subtitle.textContent = `Exported: ${now.toLocaleString()}` + (typeof USERNAME === 'string' && USERNAME ? ` • User: ${USERNAME}` : '');

        const clonedMessages = container.cloneNode(true);
        clonedMessages.classList.remove('scroll-shadow');
        clonedMessages.style.overflow = 'visible';
        clonedMessages.style.maxHeight = 'none';
        clonedMessages.style.background = '#fff';

        clonedMessages.querySelectorAll('button').forEach(b => b.remove());

        wrapper.appendChild(title);
        wrapper.appendChild(subtitle);
        wrapper.appendChild(clonedMessages);

        const pad = (n) => String(n).padStart(2, '0');
        const fname = `anova-chat-${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;

        const opt = {
            margin: [0.5, 0.5, 0.5, 0.5],
            filename: fname,
            image: {type: 'jpeg', quality: 0.95},
            html2canvas: {scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff'},
            jsPDF: {unit: 'in', format: 'letter', orientation: 'portrait'},
            pagebreak: {mode: ['css', 'legacy'], avoid: ['.bubble pre', '.bubble code']}
        };

        try {
            const dpi = 96;
            const pageHeightPx = (11 - opt.margin[0] - opt.margin[2]) * dpi * opt.html2canvas.scale;
            const approxPages = Math.ceil(wrapper.getBoundingClientRect().height / pageHeightPx);
            if (approxPages > 20) {
                toast(`Chat is too long to export (${approxPages} pages). Please shorten it.`);
                return;
            }
        } catch (_) {
        }

        html2pdf()
            .from(wrapper)
            .set(opt)
            .toPdf()
            .get('pdf')
            .then((pdf) => {
                const pages = pdf.internal.getNumberOfPages();
                if (pages > 20) {
                    toast(`Chat is too long to export (${pages} pages). Please shorten it.`);
                    return;
                }
                pdf.save(opt.filename);
            })
            .catch((e) => {
                console.error(e);
                toast('PDF export failed');
            });
    }

    const INPUT_MIN_PX = 96;
    const INPUT_MAX_PX = 560;
    const INPUT_STEP_PX = 64;

    function applySavedInputHeight() {
        const saved = parseInt(localStorage.getItem('anova_input_h') || '0', 10);
        const h = Number.isFinite(saved) && saved >= INPUT_MIN_PX ? saved : 128;
        const el = document.getElementById('input');
        if (el) el.style.height = Math.max(INPUT_MIN_PX, Math.min(INPUT_MAX_PX, h)) + 'px';
    }

    function adjustInputHeight(dir /* 1 or -1 */) {
        const el = document.getElementById('input');
        if (!el) return;
        const cur = parseInt(getComputedStyle(el).height, 10) || 128;
        const next = Math.max(INPUT_MIN_PX, Math.min(INPUT_MAX_PX, cur + dir * INPUT_STEP_PX));
        el.style.height = next + 'px';
        localStorage.setItem('anova_input_h', String(next));
    }

    document.addEventListener('keydown', (e) => {
        const meta = e.ctrlKey || e.metaKey;
        if (!meta) return;
        if (e.key === '=' || e.key === '+') {
            e.preventDefault();
            adjustInputHeight(1);
        }
        if (e.key === '-') {
            e.preventDefault();
            adjustInputHeight(-1);
        }
    });

    function setSendButtonMode(mode) {
        const b = sendBtn;
        if (!b) return;
        if (mode === "stop") {
            b.textContent = "Stop";
            b.title = "Stop response (Esc)";
            b.classList.remove("bg-bGreen", "hover:bg-bGreenHover");
            b.classList.add("bg-bRed", "hover:bg-bRedHover");
            b.classList.remove("opacity-50", "cursor-not-allowed");
        } else {
            b.textContent = "Send";
            b.title = "Send";
            b.classList.remove("bg-bRed", "hover:bg-bRedHover");
            b.classList.add("bg-bGreen", "hover:bg-bGreenHover");
            b.classList.remove("opacity-50", "cursor-not-allowed");
        }
    }

    function cancelRequest(reason = "Stopped") {
        if (!inflight) return;
        try {
            currentAbort?.abort();
        } catch (_) {
        }
        toast(reason);
    }

    applySavedInputHeight();
</script>

</body>
</html>
