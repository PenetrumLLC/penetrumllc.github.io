<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload to User - Backyard Bandwidth</title>
  <link rel="icon" href="../icons/icon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bLightBlue: "#6ec1e4",
            bLightBlueHover: "#008CCB",
            bDarkBlue: "#2d6ea8",
            bDarkGrey: "#1A1A1A",
            bLightGrey: "#A8B1B7",
            bGreen: "#4caf50",
            bGreenHover: "#008000FF",
            bRed: "#E33434",
            bRedHover: "#972424"
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-100 font-mono">
  <header class="w-full bg-black text-white flex items-center justify-between px-4 py-2 shadow-md">
    <div class="flex items-center space-x-3">
      <a href="admin-dashboard.html">
        <img src="../icons/icon.png" alt="Logo" class="max-h-14 w-auto object-contain" />
      </a>
      <span class="text-lg font-bold tracking-wide">Upload File</span>
    </div>
  </header>

  <main class="max-w-3xl mx-auto mt-10 bg-white p-6 rounded shadow space-y-6">
    <form id="upload-form" class="space-y-4">
      <input type="file" id="file" name="file" class="block w-full border border-gray-300 rounded p-2" required />

      <label for="extension" class="block font-semibold text-gray-700">File Extension</label>
      <select id="extension" class="block w-full border border-gray-300 rounded p-2">
        <option value="ovpn" selected>ovpn</option>
        <option value="proxy">proxy</option>
        <option value="custom">custom</option>
      </select>

      <button type="submit" class="bg-bGreen hover:bg-bGreenHover text-white px-4 py-2 rounded shadow">
        Upload File
      </button>
    </form>

    <!-- Spinner -->
    <div id="spinner" class="flex justify-center items-center space-x-2 mt-4 hidden">
      <svg class="animate-spin h-6 w-6 text-bDarkBlue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <span class="text-bDarkBlue font-semibold">Uploading...</span>
    </div>

    <div id="file-list" class="space-y-2 text-gray-800"></div>
    <div id="error-msg" class="text-red-600 text-sm font-semibold"></div>
    <a href="view.html" class="inline-block bg-bLightGrey hover:bg-bDarkGrey text-white px-4 py-2 rounded mt-4">‚Üê Back to All Users</a>
  </main>

  <script src="assets/js/admin_session.js"></script>
  <script>
    const username = new URLSearchParams(window.location.search).get("u");
    let API_BASE_URL = "";

    const raw = localStorage.getItem("adminSession");
    if (!raw) showError("No session found.");
    const parsed = JSON.parse(raw);
    const token = parsed?.token;
    if (!token) showError("Invalid token.");

    async function init() {
      if (!username) return showError("No username provided.");

      try {
        const res = await fetch("../data/env.json");
        const config = await res.json();
        API_BASE_URL = location.hostname.includes("localhost") || location.hostname === "127.0.0.1"
          ? config.dev
          : config.prod;
      } catch {
        return showError("Failed to load configuration.");
      }

      document.getElementById("upload-form").addEventListener("submit", handleUpload);
      fetchFileList();
    }

    async function handleUpload(e) {
      e.preventDefault();
      const spinner = document.getElementById("spinner");
      spinner.classList.remove("hidden");

      const fileInput = document.getElementById("file");
      const extSelect = document.getElementById("extension");
      const file = fileInput.files[0];
      if (!file) {
        showError("Please select a file.");
        spinner.classList.add("hidden");
        return;
      }

      let ext = extSelect.value;
      if (ext === "custom") {
        ext = prompt("Enter custom extension (lowercase letters only):");
        if (!ext || !/^[a-z]+$/.test(ext)) {
          showError("Invalid custom extension.");
          spinner.classList.add("hidden");
          return;
        }
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch(`${API_BASE_URL}/admin/users/upload`, {
          method: "POST",
          headers: {
            "x-username": username,
            "x-token": token,
            "x-file-ext": ext
          },
          body: formData
        });

        const data = await response.json();
        spinner.classList.add("hidden");

        if (!data.success) return showError(data.error?.msg || "Upload failed.");

        fileInput.value = "";
        fetchFileList();
      } catch {
        spinner.classList.add("hidden");
        showError("Upload error. Please try again.");
      }
    }

    async function fetchFileList() {
      try {
        const response = await fetch(`${API_BASE_URL}/user/get/files`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username })
        });

        const data = await response.json();
        if (!data.success) return showError(data.error?.msg || "Failed to fetch files.");
        renderFileList(data.results);
      } catch {
        showError("Error retrieving file list.");
      }
    }

function renderFileList(files) {
  const container = document.getElementById("file-list");
  if (!files || files.length === 0) {
    container.innerHTML = "<p>No files uploaded yet.</p>";
    return;
  }

  let currentPage = 1;
  const filesPerPage = 5;
  const totalPages = Math.ceil(files.length / filesPerPage);

  function showPage(page) {
    const start = (page - 1) * filesPerPage;
    const end = start + filesPerPage;
    const currentFiles = files.slice(start, end);

    container.innerHTML = `
      <h1 class="text-xl font-semibold"><u>Uploaded Files</u></h1>
      <ul class="list-disc pl-6 space-y-1">
        ${currentFiles.map(file => `<li class="break-all">${file}</li>`).join("")}
      </ul>
      <div class="flex justify-center items-center space-x-2 mt-4">
        <button ${page === 1 ? "disabled" : ""} class="px-3 py-1 rounded bg-bDarkGrey text-white disabled:opacity-50" id="prev-btn">Prev</button>
        <span class="font-semibold">Page ${page} of ${totalPages}</span>
        <button ${page === totalPages ? "disabled" : ""} class="px-3 py-1 rounded bg-bDarkGrey text-white disabled:opacity-50" id="next-btn">Next</button>
      </div>
    `;

    document.getElementById("prev-btn")?.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        showPage(currentPage);
      }
    });

    document.getElementById("next-btn")?.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        showPage(currentPage);
      }
    });
  }

  showPage(currentPage);
}


    function showError(msg) {
      document.getElementById("error-msg").textContent = msg;
    }

    init();
  </script>
</body>
</html>
